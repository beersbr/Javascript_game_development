<html>
<head>
<title>Space Shooter</title>
<style>
body{
  display: block;
}
#canvas_a{
  width: 400px;
  height: 300px;
  border: 3px solid #000000;
  display: block;
  margin: auto;
}
</style>
<script>
// This method lets us choose scope for functions so that when we use eventHandlers in javascript we 
// retain the scope of our choosing inside that eventHandler callback.
bind = function(scope, fn){
  return function(){
    fn.apply(scope, arguments);
  };
}

// This is the keyhandler on the window. You initalize it and grab the keys out of the keyHander#key(value);
// keyHandler#key(value) will return a true or false value on wheather that key is pressed or not.
function keyHandler(){
  // sets the key in the buffer variable
  this.setKey = function(key){
    // If we are setting the key for the first time make sure it has a value
    if(this.keyStates[key.keyCode] == null){
      this.keyStates[key.keyCode] = false;
    }
    this.keyStates[key.keyCode] = true;
    
    if(this.debug){
      console.log("KEY: "+key.keyCode+" => "+this.keyStates[key.keyCode]);
    }
  }

  // unsets the key in the buffer variable
  this.unsetKey = function(key){
    this.keyStates[key.keyCode] = false;
    
    if(this.debug){
      console.log("KEY: "+key.keyCode+" => "+this.keyStates[key.keyCode]);
    }
  }
  
  // This is just a getter to make the later syntax easier to read through
  this.key = function(key_value){
    if(this.keyStates[key_value]){
      return true;
    }
    return false;
  }

  // the 'constructor' values
  this.debug = false;
  this.keyStates = {};
  window.addEventListener("keydown", bind(this, this.setKey), false);
  window.addEventListener("keyup", bind(this, this.unsetKey), false);
}

// This is the movalbe functionality
function Movable(){
  this.h = null;
  this.w = null;
  this.xVel = null;
  this.yVel = null;
  this.x = null;
  this.y = null;
  this.direction = 90; // this is in degrees [deg = rad * PI / 180]
}

// Character inherets from movable
Character.prototype = new Movable();
Character.prototype.constructor = Character;

function Character(){
  
}

// This handles the images, there frames if it is an animation and any transformations
function SpriteHandler(context, image_path){
  this.rotate = function(angle){
    this.rot = angle;
    this.direction += this.rot;
    return this.rot;
  }
  
  this.scale = function(x, y){
    
  }
  
  this.draw = function(at_x, at_y){
    this.context.save();
    this.context.translate(at_x+(this.image.width/2), at_y+(this.image.height/2));
    this.context.rotate(this.direction * Math.PI / 180);
    this.rot = 0;
    this.context.drawImage(this.image, -this.image.width/2, -this.image.height/2);
    this.context.restore();
  }

  this.dir = function(){
    return this.direction - 90;
  }

  this.image = new Image();
  this.image.src = image_path;
  this.context = context;
  this.direction = 0; // degrees
  this.rot = 0;
}

// This is the main game loop
function loop(){
  if(keybuffer.key(65)){ // a
    spt.rotate(-5);
  }
  if(keybuffer.key(83)){ // s
    acc -= 0.5;
  }
  if(keybuffer.key(68)){ // d
    spt.rotate(5);
  }
  if(keybuffer.key(87)){ // w
    acc += 0.5;
  }
  if(keybuffer.key(81)){
    console.log('finished!');
    clearInterval(l);
  }
  // clear the screen and draw
  
  pos_x += Math.cos(spt.dir() * Math.PI/180) * acc;
  pos_y += Math.sin(spt.dir() * Math.PI/180) * acc;
  
  acc *= friction;
  
  ctx.clearRect(0, 0, 400, 300);
  spt.draw(pos_x, pos_y);
}

window.onload = function(){
  keybuffer = new keyHandler();
  
  ctx = document.getElementById('canvas_a').getContext('2d');
  spt = new SpriteHandler(ctx, "images/spaceship.png");
  
  speed = 2;
  friction = 0.88;
  acc = 0;
  
  pos_x = 100;
  pos_y = 100;
  
  l = setInterval(loop, 1000/60);
  
}

</script>
</head>
<body>
  <canvas id='canvas_a' width='400px' height='300px'></canvas>
</body>
</html>